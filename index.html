<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Rent Finder ‚Äì Database Notion</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* üåô Dark Mode globale */
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #ffffff;
      margin: 0;
      padding: 0;
    }
    header {
      text-align: center;
      padding: 20px;
      background: #1f1f1f;
    }
    h1 { margin: 0; font-size: 1.8em; }
    .container {
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .filters label {
      display: flex;
      flex-direction: column;
      font-size: 0.9em;
    }
    .filters input, .filters select {
      padding: 6px;
      border-radius: 4px;
      border: none;
      margin-top: 4px;
      background: #2a2a2a;
      color: #fff;
    }
    .card {
      background: #1f1f1f;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .card h2 { margin: 0 0 10px 0; font-size: 1.2em; }
    .card a {
      color: #4da3ff;
      text-decoration: none;
    }
    .card a:hover { text-decoration: underline; }
    .loading, .error {
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üè† Rent Finder</h1>
    <p>Annunci aggiornati da Notion (via GitHub Actions)</p>
  </header>

  <div class="container">
    <div class="filters">
      <label>Zona:
        <select id="filter-zone"><option value="">Tutte</option></select>
      </label>
      <label>Camere:
        <select id="filter-rooms"><option value="">Tutte</option></select>
      </label>
      <label>Affidabilit√† minima:
        <select id="filter-reliability">
          <option value="">Tutte</option>
          <option value="1">‚â• 1</option>
          <option value="2">‚â• 2</option>
          <option value="3">‚â• 3</option>
          <option value="4">‚â• 4</option>
          <option value="5">‚â• 5</option>
        </select>
      </label>
      <label>Prezzo massimo (‚Ç¨):
        <input type="number" id="filter-price" placeholder="Es. 1200">
      </label>
    </div>

    <div id="loading" class="loading">‚è≥ Caricamento annunci...</div>
    <div id="listings"></div>
  </div>

  <script>
    let allListings = [];

    // üîπ Funzione per leggere i dati dal JSON generato dal workflow
    async function loadListings() {
      try {
        const response = await fetch("public/data.json"); // file aggiornato da GitHub Actions
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();

        allListings = (data.results || []);
        document.getElementById('loading').style.display = 'none';
        populateFilters();
        applyFilters();
      } catch (error) {
        console.error("Errore:", error);
        document.getElementById('loading').innerHTML = `
          <h3 class="error">‚ö†Ô∏è Errore nel caricamento</h3>
          <p>Verifica che il workflow abbia generato <code>public/data.json</code></p>
          <p style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">${error.message}</p>
        `;
      }
    }

    // üîπ Popola i filtri da dati
    function populateFilters() {
      const zones = [...new Set(allListings.map(i => i.zone).filter(Boolean))];
      const rooms = [...new Set(allListings.map(i => i.rooms).filter(Boolean))];

      const zoneSelect = document.getElementById('filter-zone');
      zones.forEach(z => zoneSelect.add(new Option(z, z)));

      const roomsSelect = document.getElementById('filter-rooms');
      rooms.forEach(r => roomsSelect.add(new Option(r, r)));
    }

    // üîπ Applica i filtri
    function applyFilters() {
      const zone = document.getElementById('filter-zone').value;
      const rooms = document.getElementById('filter-rooms').value;
      const minReliability = parseInt(document.getElementById('filter-reliability').value) || 0;
      const maxPrice = parseInt(document.getElementById('filter-price').value) || Infinity;

      const filtered = allListings.filter(l =>
        (!zone || l.zone === zone) &&
        (!rooms || l.rooms === rooms) &&
        (l.reliability >= minReliability) &&
        (parseInt(l.price) <= maxPrice)
      );

      renderListings(filtered);
    }

    // üîπ Renderizza le card
    function renderListings(listings) {
      const container = document.getElementById('listings');
      container.innerHTML = "";
      if (listings.length === 0) {
        container.innerHTML = `<p>Nessun annuncio trovato.</p>`;
        return;
      }
      listings.forEach(l => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <h2>${l.title || "Senza titolo"}</h2>
          <p><b>Zona:</b> ${l.zone || "N/A"} | <b>Camere:</b> ${l.rooms || "N/A"}</p>
          <p><b>Prezzo:</b> ${l.price || "N/A"}</p>
          <p><b>Affidabilit√†:</b> ${l.reliability} ‚≠ê</p>
          <p>${l.overview || ""}</p>
          <p><a href="${l.link}" target="_blank">üîó Vedi annuncio</a></p>
        `;
        container.appendChild(div);
      });
    }

    // Eventi sui filtri
    document.getElementById('filter-zone').addEventListener('change', applyFilters);
    document.getElementById('filter-rooms').addEventListener('change', applyFilters);
    document.getElementById('filter-reliability').addEventListener('change', applyFilters);
    document.getElementById('filter-price').addEventListener('input', applyFilters);

    // Avvio
    loadListings();
  </script>
</body>
</html>
